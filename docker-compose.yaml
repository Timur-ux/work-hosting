services:
  # postgres:
  #   image: postgres:latest
  #   restart: always
  #   environment:
  #     POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-qwerty}"
  #     POSTGRES_USER: "${POSTGRES_USER:-admin}"
  #     POSTGRES_DB: "workHosting"
  #   volumes:
  #     - "./init/pg:/docker-entrypoint-initdb.d:ro"
  #     - "${STORAGE_PATH:-/tmp}/postgres:/var/lib/postgresql"
  #   networks:
  #     - backend-db

  api:
    build:
      context: .
      dockerfile: ./docker/api.dockerfile
    environment:
      CHECKER_ADDR: "tcp://checker:55555"
    volumes:
      - "${LOG_PATH:-/tmp}/api/:/logs/"
    security_opt:
      - seccomp=unconfined
    depends_on:
      - checker
      # - postgresql
    networks:
      - frontend
      - backend-api
      - backend-checker
      # - backend-db

  checker:
    build:
      context: .
      dockerfile: ./docker/checker.dockerfile
    environment:
      CHECKER_ADDR: "tcp://checker:55555"
      LOG_PATH: "/logs/checker.log"
    volumes:
      - "${STORAGE_PATH:-/tmp}/checker:/checker"
      - "${LOG_PATH:-/tmp}/checker:/logs"
      - "${HOME}/.ssh:/home/checker/.ssh:ro"
      - "./backend/scripts:/scripts"
      - "./init/checker/init.sh:/init.sh"
    networks:
      - backend-checker

  web:
    build:
      context: ./frontend/
    networks:
      - frontend
      - backend-api

  nginx:
    image: nginx:1.29.4
    ports:
      - "80:8080"
    volumes:
      - "./cfg/nginx/nginx.conf:/etc/nginx/nginx.conf"
      - "${LOG_PATH:-/tmp}/nginx:/usr/local/nginx/logs"
      - "${STORAGE_PATH:-/tmp}/checker:/checker"
    depends_on:
      - api
      - web
    networks:
      - frontend
      - backend-api


networks:
  backend-api:
    driver: bridge

  backend-checker:
    driver: bridge
  
  # backend-db:
  #   driver: bridge

  frontend:
    driver: bridge
